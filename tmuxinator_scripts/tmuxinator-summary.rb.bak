#!/usr/bin/env ruby
# Tmuxinator project summary with progress reports
# Usage: tmuxinator-summary
# Reads project configs sorted by ddl/priority and displays prgs.md from each project root

require 'yaml'
require 'date'
require 'fileutils'

# Use safe YAML loading
YAML::ENGINE.yamler = 'psych' if defined?(YAML::ENGINE)

# Find tmuxinator config directory
config_dir = File.expand_path('~/.config/tmuxinator')
config_dir = File.expand_path('~/.tmuxinator') unless Dir.exist?(config_dir)

unless Dir.exist?(config_dir)
  puts "Error: Tmuxinator config directory not found"
  exit 1
end

# Collect project info
projects = []
Dir.glob(File.join(config_dir, '*.yml')).each do |file|
  begin
    # Skip template file
    next if File.basename(file) == 'template.yml'

    config = YAML.safe_load(File.read(file), permitted_classes: [Date, Time, Symbol], aliases: true)
    next unless config.is_a?(Hash)

    project_name = config['name'] || File.basename(file, '.yml')
    ddl_str = config['ddl']
    description = config['description'] || ''
    priority = config['priority'] || 'normal'
    root = config['root']

    # Parse ddl
    ddl = nil
    if ddl_str
      begin
        ddl = Date.parse(ddl_str.to_s)
      rescue ArgumentError
        # Invalid date format, will be treated as no ddl
      end
    end

    # Expand tilde in root path
    root = File.expand_path(root) if root

    projects << {
      name: project_name,
      ddl: ddl,
      ddl_str: ddl_str,
      description: description,
      priority: priority,
      root: root,
      file: file
    }
  rescue => e
    STDERR.puts "Warning: Failed to parse #{file}: #{e.message}"
  end
end

# Sort projects: with ddl first (sorted by date), then without ddl (sorted by name)
projects_with_ddl = projects.select { |p| p[:ddl] }.sort_by { |p| [p[:ddl], p[:name]] }
projects_without_ddl = projects.reject { |p| p[:ddl] }.sort_by { |p| p[:name] }

# Combine: projects with ddl first, then without ddl
sorted_projects = projects_with_ddl + projects_without_ddl

# Display
if sorted_projects.empty?
  puts "No tmuxinator projects found in #{config_dir}"
  exit 0
end

puts
puts "="*80
puts "PROJECT SUMMARY - #{Date.today.strftime('%Y-%m-%d')}"
puts "="*80
puts

today = Date.today

sorted_projects.each_with_index do |project, index|
  # Project header
  puts "\n" if index > 0
  puts "─"*80

  # Project name and basic info
  project_header = "#{project[:name]}"

  # Add priority indicator
  priority_indicator = case project[:priority].to_s.downcase
  when 'high', 'urgent' then "\e[31m[HIGH]\e[0m"
  when 'low' then "\e[90m[LOW]\e[0m"
  else ""
  end

  print "\e[1m#{project_header}\e[0m"
  print " #{priority_indicator}" unless priority_indicator.empty?
  puts

  # Deadline info
  if project[:ddl]
    days_left = (project[:ddl] - today).to_i

    if days_left < 0
      status = "\e[31m⚠ OVERDUE by #{days_left.abs}d\e[0m"
    elsif days_left == 0
      status = "\e[33m● DUE TODAY\e[0m"
    elsif days_left <= 3
      status = "\e[31m● URGENT (#{days_left}d left)\e[0m"
    elsif days_left <= 7
      status = "\e[33m● SOON (#{days_left}d left)\e[0m"
    else
      status = "\e[32m○ #{days_left}d left\e[0m"
    end

    puts "DDL: #{project[:ddl_str]} #{status}"
  else
    puts "DDL: \e[90mNo deadline\e[0m"
  end

  # Description
  puts "Description: #{project[:description]}" unless project[:description].empty?

  # Root path
  if project[:root]
    puts "Path: #{project[:root]}"
  else
    puts "Path: \e[90mNot specified\e[0m"
  end

  puts

  # Try to read prgs.md
  if project[:root] && Dir.exist?(project[:root])
    prgs_file = File.join(project[:root], 'prgs.md')

    if File.exist?(prgs_file)
      puts "\e[1mProgress:\e[0m"
      puts

      # Read and display prgs.md content
      prgs_content = File.read(prgs_file)

      # Indent the content slightly for better visual hierarchy
      prgs_content.each_line do |line|
        print "  #{line}"
      end
      puts unless prgs_content.end_with?("\n")
    else
      puts "\e[90m[No prgs.md found]\e[0m"
    end
  else
    if project[:root]
      puts "\e[90m[Project root directory not found: #{project[:root]}]\e[0m"
    else
      puts "\e[90m[No root path specified]\e[0m"
    end
  end
end

puts
puts "─"*80
puts
puts "Total: #{sorted_projects.length} projects"
puts "  With deadlines: #{projects_with_ddl.length}"
puts "  Without deadlines: #{projects_without_ddl.length}"

# Count projects with prgs.md
projects_with_progress = sorted_projects.count do |p|
  p[:root] && Dir.exist?(p[:root]) && File.exist?(File.join(p[:root], 'prgs.md'))
end
puts "  With progress reports: #{projects_with_progress}"
puts
